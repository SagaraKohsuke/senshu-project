# 朝夕食予約システム (Meal Reservation System)

Always reference these instructions first and fallback to search or bash commands only when you encounter unexpected information that does not match the info here.

This is a Japanese meal reservation system built with Google Apps Script (GAS) and Google Spreadsheet as the database. The system allows users to manage breakfast and dinner reservations through a calendar interface.

## Quick Start for Coding Agents

**MOST IMPORTANT**: This is a Google Apps Script project, NOT a Node.js app. No building required.

1. **Install validation tools** (one time setup): 
   ```bash
   npm install -g @google/clasp jshint html-validate
   ```

2. **ALWAYS validate before making changes**:
   ```bash
   jshint *.gs        # Check JavaScript syntax
   html-validate *.html --quiet  # Check HTML structure
   ```

3. **Make changes to .gs or .html files locally**

4. **Copy code to Google Apps Script editor** (script.google.com) to deploy

5. **Test manually in the deployed web application** - no local testing possible

## Working Effectively

### Repository Structure
- **Backend**: Google Apps Script files (*.gs)
  - `main.gs` - Entry point with doGet() function for web app deployment
  - `user.gs` - User management functions
  - `calendar.gs` - Calendar sheet creation and management
  - `reservation.gs` - Reservation CRUD operations (543 lines - main business logic)
  - `trigger.gs` - Monthly automated triggers for sheet management
  - `questionnaire.gs` - Contact form handling
  - `utils.gs` - Date formatting utilities
- **Frontend**: HTML files with inline CSS/JavaScript
  - `index.html` - Main Vue.js 2.6.14 application (1,319 lines)
  - `contact.html` - Contact/questionnaire form (257 lines)
- **Configuration**:
  - `appsscript.json` - GAS project configuration
  - `.jshintrc` - JavaScript linting configuration (ES6 with GAS globals)

### Essential Setup Steps
This is NOT a traditional Node.js project. There is no package.json, no build process, and no local server.

1. **Install development tools** (for validation only):
   ```bash
   # Install Node.js development tools (takes 30-60 seconds)
   npm install -g @google/clasp jshint html-validate
   
   # Verify installations
   clasp --version    # Should show 3.0.6-alpha or similar
   jshint --version   # Should show 2.x
   html-validate --version
   ```

2. **Local validation commands** (ALWAYS run these before committing):
   ```bash
   # JavaScript linting (takes <1 second) - ALWAYS run this
   jshint *.gs
   
   # HTML validation (takes <2 seconds) - ALWAYS run this  
   html-validate *.html
   ```

### Deployment Process
**CRITICAL**: This project deploys to Google Apps Script, NOT to a traditional web server.

1. **Create Google Spreadsheet** with these required sheets:
   - `users` (user_id, name)
   - `b_menu` (b_menu_id, breakfast_menu)
   - `d_menu` (d_menu_id, dinner_menu)
   - Monthly sheets are auto-generated by triggers

2. **Deploy to Google Apps Script**:
   - Open Google Apps Script editor (script.google.com)
   - Create new project
   - Copy/paste each .gs file content into corresponding script files
   - Copy/paste HTML file content into HTML files
   - Update spreadsheet ID in `main.gs` (line 7)
   - Deploy as web application with "Execute as: User deploying" and "Who has access: Anyone, even anonymous"

3. **Set up triggers**:
   ```javascript
   // Run in GAS editor to set monthly triggers
   setMonthlyTrigger()
   ```

### Testing and Validation

**MANUAL VALIDATION REQUIREMENT**: Since this is a GAS web app, you CANNOT run it locally. You MUST test in the deployed environment.

**ALWAYS test these scenarios after making changes**:
1. **User Selection**: Select a user from dropdown, verify calendar loads
2. **Calendar Navigation**: Click previous/next month buttons, verify data loads
3. **Reservation Changes**: 
   - Click breakfast checkbox to reserve/unreserve
   - Click dinner checkbox to reserve/unreserve  
   - Verify checkboxes reflect actual database state
4. **Deadline Logic**: Test at 12:00 PM to verify breakfast deadlines are enforced
5. **Contact Form**: Submit a test message via contact.html

**Validation Commands** (run locally before deployment):
```bash
# ALWAYS run before committing - takes <3 seconds total
jshint *.gs
html-validate *.html
```

**Expected Validation Output**:
JSHint will show these warnings (acceptable in GAS environment):
```
reservation.gs: line 177, col 12, 'object spread property' is only available in ES9
reservation.gs: line 190, col 12, 'object spread property' is only available in ES9
trigger.gs: line 2, col 44, Missing semicolon
trigger.gs: line 3, col 38, Missing semicolon
```

HTML validation will show styling warnings (acceptable for inline styles in GAS):
```
✖ 43 problems (43 errors, 0 warnings) - mostly trailing whitespace and inline styles
```

**CRITICAL Issues to Fix**:
- Missing semicolons in trigger.gs (lines 2, 3) - FIX these
- Syntax errors in .gs files - FIX immediately
- Missing lang attribute in HTML - acceptable to ignore for GAS
- Trailing whitespace and inline styles - acceptable to ignore

### Key Business Logic

**Data Flow**:
1. Monthly triggers create calendar sheets (b_calendar_YYYYMM, d_calendar_YYYYMM)
2. Reservation sheets (b_reservations_YYYYMM, d_reservations_YYYYMM) track user preferences
3. Frontend loads user's monthly data and allows checkbox-based reservation changes
4. Real-time updates via `updateReservation()` function

**Critical Rules**:
- Sunday meals are not available (excluded from calendar generation)
- Saturday dinner is not available 
- Breakfast deadline: Previous day 12:00 PM
- Dinner deadline: Same day 12:00 PM
- Monthly sheet cleanup: Deletes sheets from 2 months ago

## Timing and Performance

**NEVER CANCEL long-running operations** - the following are normal:
- JavaScript linting: <1 second
- HTML validation: <2 seconds  
- GAS deployment: 30-60 seconds (manual process)
- Initial calendar sheet creation: 5-10 seconds per month in GAS editor
- Monthly trigger execution: 10-30 seconds (automated)

Set timeouts of 60+ seconds when testing GAS functions that manipulate spreadsheet data.

## Repository Root Contents

```bash
ls -la  # View all project files
```
Expected output:
```
-rw-r--r-- 1 user user  2733 calendar.gs          # Calendar sheet management  
-rw-r--r-- 1 user user  8417 contact.html         # Contact form page
-rw-r--r-- 1 user user 41569 index.html          # Main Vue.js application  
-rw-r--r-- 1 user user   256 main.gs             # Entry point and config
-rw-r--r-- 1 user user   707 questionnaire.gs    # Contact form handler
-rw-r--r-- 1 user user 17834 reservation.gs      # Main business logic
-rw-r--r-- 1 user user  2898 trigger.gs          # Monthly automation
-rw-r--r-- 1 user user   561 user.gs             # User management  
-rw-r--r-- 1 user user   226 utils.gs            # Date utilities
-rw-r--r-- 1 user user   202 appsscript.json     # GAS configuration
-rw-r--r-- 1 user user   198 .jshintrc           # Linting config
```

## Common Development Tasks

### Making Code Changes
1. **Edit .gs or .html files locally**
2. **Run validation**: `jshint *.gs && html-validate *.html`  
3. **Fix any critical errors** (syntax errors, missing semicolons)
4. **Copy updated code to GAS editor**
5. **Test the deployed web app manually**

### Adding New Features
1. **Identify affected files**: Usually reservation.gs (main logic) and index.html (UI)
2. **Follow existing patterns**: Month-based sheet naming, Vue.js reactive data
3. **Test with actual spreadsheet data**: GAS functions cannot be mocked locally
4. **Validate user scenarios**: Always test the complete user workflow

### Debugging Issues
1. **Check GAS execution logs**: View > Execution transcript in GAS editor
2. **Test individual functions**: Use GAS editor's function runner
3. **Verify spreadsheet structure**: Ensure required sheets exist with correct column headers
4. **Check spreadsheet IDs**: Verify hardcoded IDs match your test/production sheets

## Important File Locations

**Critical configuration**:
- `main.gs` line 7: Main spreadsheet ID (17XAfgiRV7GqcVqrT_geEeKFQ8oKbdFMaOfWN0YM_9uk)
- `questionnaire.gs` line 2: Contact form spreadsheet ID (1-FWRtkpGNKHrLtc2V-f66ygsAI67wPaaWkt26R_Pg1c)

**Main business logic**:
- `reservation.gs` lines 1-200: User calendar data retrieval
- `reservation.gs` lines 201-400: Reservation update logic
- `calendar.gs` lines 37-60: Monthly sheet generation logic
- `index.html` lines 800-1000: Vue.js reservation management

**Frontend assets**:
- Vue.js 2.6.14 loaded from CDN (index.html line 8)
- All CSS and JavaScript is inline in HTML files
- No external dependencies except Vue.js CDN

## DO NOT Do These Things

- Do NOT try to run this as a Node.js application (no package.json, no local server)
- Do NOT expect traditional build tools to work (webpack, npm scripts, etc.)
- Do NOT attempt to mock SpreadsheetApp or other GAS APIs locally
- Do NOT skip manual testing - automated testing is not possible for GAS web apps
- Do NOT cancel long-running GAS operations in the editor - let them complete
- Do NOT change the spreadsheet schema without updating ALL affected functions

Always validate locally with linting tools, then test manually in the deployed GAS environment.